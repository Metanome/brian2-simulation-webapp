<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Brian2 Simulation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .form-group { margin-bottom: 1em; }
        .form-row { display: flex; align-items: center; gap: 0.5em; flex-wrap: wrap; }
        .form-row label { min-width: 120px; }
        .section-title { margin-top: 2em; margin-bottom: 0.5em; font-size: 1.2em; font-weight: bold; }
        .tooltip { border-bottom: 1px dotted #333; cursor: help; }
        @media (max-width: 600px) {
            .form-row { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ðŸ§  Brian2 Simulation</h1>

    <!-- Show error messages -->
    <div aria-live="polite">
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <ul style="color: red;">
          {% for message in messages %}
            <li>{{ message }}</li>
          {% endfor %}
        </ul>
      {% endif %}
    {% endwith %}
    </div>

    <div class="section-title">1. Neuron Model</div>
    <div class="form-group form-row">
        <label for="neuron_model">Neuron Model:</label>
        <select id="neuron_model" name="neuron_model" onchange="showModelFields(this.value)">
            <option value="lif">Leaky Integrate-and-Fire (LIF)</option>
            <option value="izhikevich">Izhikevich</option>
            <option value="adex">Adaptive Exponential (AdEx)</option>
            <option value="custom">Custom</option>
        </select>
        <span class="tooltip" title="Choose the neuron model type.">?</span>
    </div>

    <!-- 2. Model-specific parameter fields -->
    <div id="izhikevich-fields" class="form-group" style="display:none;">
        <div class="form-row"><label>a: <input type="number" step="any" name="izh_a" value="0.02"></label></div>
        <div class="form-row"><label>b: <input type="number" step="any" name="izh_b" value="0.2"></label></div>
        <div class="form-row"><label>c: <input type="number" step="any" name="izh_c" value="-65"></label></div>
        <div class="form-row"><label>d: <input type="number" step="any" name="izh_d" value="2"></label></div>
    </div>
    <div id="adex-fields" class="form-group" style="display:none;">
        <div class="form-row"><label>a: <input type="number" step="any" name="adex_a" value="0.02"></label></div>
        <div class="form-row"><label>b: <input type="number" step="any" name="adex_b" value="0.2"></label></div>
        <div class="form-row"><label>&Delta;T: <input type="number" step="any" name="adex_deltaT" value="2"></label></div>
        <div class="form-row"><label>&tau;<sub>w</sub>: <input type="number" step="any" name="adex_tau_w" value="30"></label></div>
    </div>
    <div id="custom-fields" class="form-group" style="display:none;">
        <div class="form-row">
            <label>Equations:<br>
                <textarea name="custom_eqs" rows="4" cols="50" placeholder="dv/dt = ..."></textarea>
            </label>
        </div>
        <div class="form-row">
            <label>Threshold:<br>
                <input type="text" name="custom_threshold" placeholder="e.g. v > 1"/>
            </label>
        </div>
        <div class="form-row">
            <label>Reset:<br>
                <input type="text" name="custom_reset" placeholder="e.g. v = 0"/>
            </label>
        </div>
    </div>    

    <div class="section-title">2. Presets</div>
    <div class="form-group form-row">
        <label for="preset">Presets:</label>
        <select id="preset" onchange="applyPreset(this.value)">
            <option value="custom">Custom (edit freely)</option>
            <option value="lif_quickstart">LIF Quickstart (classic small network)</option>
            <option value="balanced_random">Balanced Random Network (medium, more neurons, more noise)</option>
            <option value="strongly_coupled">Strongly Coupled Network (dense, strong synapses, multiplicative noise)</option>
            <option value="sparse_excitatory">Sparse Excitatory Network (small, weak coupling, sparse)</option>
            <option value="inhibition_dominated">Inhibition-Dominated Network (medium, strong inhibition)</option>
            <option value="noisy_single">Noisy Single Neuron (single cell, high noise)</option>
            <option value="synchronous_bursting">Synchronous Bursting (medium, high coupling, low noise)</option>
            <option value="minimal">Minimal Network (2 neurons, no noise, weak synapses)</option>
        </select>
        <span class="tooltip" title="Quickly set parameters for common scenarios.">?</span>
    </div>
    <small id="preset-desc" class="info-label">
        Set your own parameters or pick a preset to see a typical network scenario.
    </small>

    <div class="section-title">3. Simulation Parameters</div>
    <form method="POST" action="/simulate" id="simForm" autocomplete="off">
        <div id="threshold-reset-fields" class="form-group">
            <div class="form-row">
                <label for="threshold">
                    Threshold:
                    <input type="number" step="any" name="threshold" id="threshold" value="{{ threshold or 1.0 }}">
                </label>
                <label for="reset">
                    Reset:
                    <input type="number" step="any" name="reset" id="reset" value="{{ reset or 0.0 }}">
                </label>
                <span class="tooltip" title="Used for LIF only. Ignored for Izhikevich and AdEx.">?</span>
            </div>
            <small id="threshold-reset-help" class="info-label">
                Used for LIF only. Ignored for Izhikevich and AdEx.
            </small>
        </div>

        <div class="form-group form-row">
            <label>Simulation Time (ms):
                <input type="number" step="1" name="sim_time" value="{{ sim_time or 100 }}">
            </label>
            <span class="tooltip" title="Total duration of the simulation in milliseconds.">?</span>
        </div>

        <div class="form-group form-row">
            <label for="input_current">
                Input Current:
                <input type="number" step="any" name="input_current" id="input_current" value="{{ input_current or 1.2 }}">
            </label>
            <span class="tooltip" title="Units: Arbitrary for LIF/Izhikevich, pA for AdEx.">?</span>
        </div>
        <small id="input-current-help" class="info-label">
            Units: Arbitrary for LIF/Izhikevich, pA for AdEx.
        </small>

        <div class="form-group form-row">
            <label>Number of Neurons:
                <input type="number" step="1" min="1" name="num_neurons" value="{{ num_neurons or 5 }}">
            </label>
            <span class="tooltip" title="How many neurons to simulate in the network.">?</span>
        </div>

        <div class="form-group form-row">
            <label>Current Start (ms):
                <input type="number" step="1" min="0" name="current_start" value="{{ current_start or 0 }}">
            </label>
            <span class="tooltip" title="Time when current injection begins.">?</span>
        </div>

        <div class="form-group form-row">
            <label>Current Duration (ms):
                <input type="number" step="1" min="0" name="current_duration" value="{{ current_duration or sim_time or 100 }}">
            </label>
            <span class="tooltip" title="How long the current injection lasts.">?</span>
        </div>

        <div class="section-title">4. Noise Options</div>
        <div class="form-group form-row">
            <label>
                <input type="checkbox" name="noise" id="noise" {% if noise %}checked{% endif %} onchange="toggleNoiseOptions()">
                Add Noise
            </label>
            <span class="tooltip" title="Add random fluctuations to the input current (simulates biological noise).">?</span>
        </div>
        <div id="noise-options" class="form-group" style="display: none;">
            <div class="form-row">
                <label>Noise Intensity:
                    <input type="number" step="0.01" name="noise_intensity" id="noise_intensity" value="{{ noise_intensity or 0.2 }}">
                </label>
                <span class="tooltip" title="Strength of the noise added to the input current.">?</span>
            </div>
            <div class="form-row">
                <label>Noise Method:
                    <select name="noise_method" id="noise_method">
                        <option value="additive" {% if noise_method == 'additive' %}selected{% endif %}>Additive</option>
                        <option value="multiplicative" {% if noise_method == 'multiplicative' %}selected{% endif %}>Multiplicative</option>
                    </select>
                </label>
                <span class="tooltip" title="Additive: noise is added to the current. Multiplicative: noise scales the current.">?</span>
            </div>
        </div>

        <div class="section-title">5. Synaptic Interactions</div>
        <div class="form-group form-row">
            <label>
                <input type="checkbox" name="synapse" id="synapse" {% if synapse %}checked{% endif %} onchange="toggleSynapseOptions()">
                Enable Synaptic Interactions
            </label>
            <span class="tooltip" title="Allow neurons to interact via synapses (network connectivity). Synaptic events include a biologically realistic delay.">?</span>
        </div>
        <div id="synapse-options" class="form-group" style="display: none;">
            <div class="form-row">
                <label>Synaptic Weight:
                    <input type="number" step="0.01" name="syn_weight" id="syn_weight" value="{{ syn_weight or 0.2 }}">
                </label>
                <span class="tooltip" title="Strength of each synaptic connection (how much a spike affects other neurons).">?</span>
            </div>
            <div class="form-row">
                <label>Connection Probability:
                    <input type="number" step="0.01" min="0" max="1" name="syn_prob" id="syn_prob" value="{{ syn_prob or 0.2 }}">
                </label>
                <span class="tooltip" title="Probability that any two neurons are connected by a synapse.">?</span>
            </div>
        </div>

        <div class="section-title">6. Output Options</div>
        <div class="form-group form-row">
            <label>Output Type:
                <select name="output_type" id="output_type">
                    <option value="both" {% if output_type == 'both' %}selected{% endif %}>Both</option>
                    <option value="voltage" {% if output_type == 'voltage' %}selected{% endif %}>Voltage Only</option>
                    <option value="raster" {% if output_type == 'raster' %}selected{% endif %}>Raster Only</option>
                </select>
            </label>
            <span class="tooltip" title="Choose which plots to display: membrane voltage, spike raster, or both.">?</span>
        </div>
        <div class="form-group form-row">
            <label for="plot_type">Plot Type:</label>
            <select name="plot_type" id="plot_type">
                <option value="interactive" {% if plot_type != 'static' %}selected{% endif %}>Interactive (Plotly)</option>
                <option value="static" {% if plot_type == 'static' %}selected{% endif %}>Static (Matplotlib)</option>
            </select>
            <span class="tooltip" title="Choose between interactive (Plotly) or static (Matplotlib) plots.">?</span>
        </div>

        <!-- 8. Run/submit buttons -->
        <div class="form-group form-row">
            <button type="submit">Run Simulation</button>
            <button type="button" onclick="resetDefaults()">Reset</button>
        </div>
    </form>

    <!-- Spinner shown while simulation runs -->
    <div id="spinner" style="display:none;" aria-live="polite">
        <span>Running simulation, please wait...</span>
    </div>

    <!-- Output plots and download links -->
    {% if plot_type == 'static' %}
        {% if img_url %}
            <div class="output">
                <h4>Membrane Potential Plot (Static)</h4>
                <img src="{{ img_url }}" alt="Membrane Potential Plot">
            </div>
        {% endif %}
        {% if raster_url %}
            <div class="output">
                <h4>Spike Raster Plot (Static)</h4>
                <img src="{{ raster_url }}" alt="Spike Raster Plot">
            </div>
        {% endif %}
    {% else %}
        {% if plotly_voltage_html %}
            <div class="output">
                <h4>Membrane Potential Plot (Interactive)</h4>
                {{ plotly_voltage_html|safe }}
            </div>
        {% endif %}
        {% if plotly_raster_html %}
            <div class="output">
                <h4>Spike Raster Plot (Interactive)</h4>
                {{ plotly_raster_html|safe }}
            </div>
        {% endif %}
    {% endif %}

    {% if data_url or json_url %}
    <div class="downloads">
        <h4>Download Simulation Data:</h4>
        {% if data_url %}
        <a href="{{ data_url }}" download>CSV</a>
        {% endif %}
        {% if json_url %}
        <a href="{{ json_url }}" download>JSON</a>
        {% endif %}
    </div>
    {% endif %}

    {% if sim_time_seconds %}
    <div class="info-label">
        <strong>Simulation runtime:</strong> {{ "%.3f"|format(sim_time_seconds) }} seconds
    </div>
    {% endif %}
</div>

<script>
// Move all DOM access inside window.onload to avoid null errors
window.onload = function() {
    // Spinner on submit
    document.getElementById('simForm').onsubmit = function() {
        document.getElementById('spinner').style.display = 'block';
    };

    // Initial UI state
    var model = document.getElementById('neuron_model').value;
    showModelFields(model);
    toggleNoiseOptions();
    toggleSynapseOptions();

    // Fix: update preset-desc on load
    document.getElementById('preset-desc').innerText = presetDescriptions[document.getElementById('preset').value] || presetDescriptions['custom'];

    // Fix: update model fields on change
    document.getElementById('neuron_model').addEventListener('change', function() {
        showModelFields(this.value);
    });
    // Fix: update preset-desc on change
    document.getElementById('preset').addEventListener('change', function() {
        document.getElementById('preset-desc').innerText = presetDescriptions[this.value] || presetDescriptions['custom'];
        // 6. Preset Model Sync: update neuron model if preset implies a model
        const presetToModel = {
            lif_quickstart: 'lif',
            balanced_random: 'lif',
            strongly_coupled: 'lif',
            sparse_excitatory: 'lif',
            inhibition_dominated: 'lif',
            noisy_single: 'lif',
            synchronous_bursting: 'lif',
            minimal: 'lif'
            // Add mapping if you have presets for other models
        };
        if (presetToModel[this.value]) {
            document.getElementById('neuron_model').value = presetToModel[this.value];
            showModelFields(presetToModel[this.value]);
        }
    });

    // 12. Remember Last Used Settings
    if (window.localStorage) {
        // Restore last settings if available
        const saved = localStorage.getItem('brian2sim-settings');
        if (saved) {
            try {
                setFields(JSON.parse(saved));
            } catch (e) {}
        }
        // Save on change
        document.getElementById('simForm').addEventListener('change', function() {
            localStorage.setItem('brian2sim-settings', JSON.stringify(getFields()));
        });
    }
};

const defaults = {
    threshold: 1.0,
    reset: 0.0,
    sim_time: 100,
    input_current: 1.2,
    num_neurons: 5,
    current_start: 0,
    current_duration: 100,
    noise: true,
    noise_intensity: 0.2,
    noise_method: "additive",
    synapse: true,
    syn_weight: 0.2,
    syn_prob: 0.2,
    output_type: "both"
};

const presetDescriptions = {
    custom: "Set your own parameters or pick a preset to see a typical network scenario.",
    lif_quickstart: "A classic Leaky Integrate-and-Fire (LIF) network with 5 neurons, moderate input, and sparse synapses. Great for quick demos.",
    balanced_random: "A medium-sized network with 20 neurons, more noise, and sparse random connectivity. Useful for exploring asynchronous firing.",
    strongly_coupled: "A large, densely connected network with strong synapses and multiplicative noise. Shows rich, collective dynamics.",
    sparse_excitatory: "A small network with weak, sparse excitatory coupling and moderate noise. Good for observing isolated spikes.",
    inhibition_dominated: "A medium network dominated by strong inhibitory synapses. Demonstrates suppression and competition.",
    noisy_single: "A single neuron with high noise and no synapses. Useful for exploring stochastic firing and membrane fluctuations.",
    synchronous_bursting: "A medium network with high synaptic weight and probability, low noise. Promotes synchronous bursts.",
    minimal: "A minimal network of 2 neurons, no noise, weak synapses. Useful for debugging and basic connectivity tests."
};

function applyPreset(preset) {
    if (preset === "lif_quickstart") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 100, input_current: 1.2, num_neurons: 5,
            current_start: 0, current_duration: 100, noise: true, noise_intensity: 0.2,
            noise_method: "additive", synapse: true, syn_weight: 0.2, syn_prob: 0.2, output_type: "both"
        });
    } else if (preset === "balanced_random") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 200, input_current: 1.0, num_neurons: 20,
            current_start: 0, current_duration: 200, noise: true, noise_intensity: 0.4,
            noise_method: "additive", synapse: true, syn_weight: 0.3, syn_prob: 0.1, output_type: "both"
        });
    } else if (preset === "strongly_coupled") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 300, input_current: 1.5, num_neurons: 50,
            current_start: 0, current_duration: 300, noise: true, noise_intensity: 0.5,
            noise_method: "multiplicative", synapse: true, syn_weight: 0.8, syn_prob: 0.5, output_type: "both"
        });
    } else if (preset === "sparse_excitatory") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 150, input_current: 1.1, num_neurons: 10,
            current_start: 0, current_duration: 150, noise: true, noise_intensity: 0.15,
            noise_method: "additive", synapse: true, syn_weight: 0.1, syn_prob: 0.05, output_type: "both"
        });
    } else if (preset === "inhibition_dominated") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 200, input_current: 1.3, num_neurons: 20,
            current_start: 0, current_duration: 200, noise: true, noise_intensity: 0.25,
            noise_method: "additive", synapse: true, syn_weight: -0.5, syn_prob: 0.2, output_type: "both"
        });
    } else if (preset === "noisy_single") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 100, input_current: 1.0, num_neurons: 1,
            current_start: 0, current_duration: 100, noise: true, noise_intensity: 0.5,
            noise_method: "additive", synapse: false, syn_weight: 0.0, syn_prob: 0.0, output_type: "both"
        });
    } else if (preset === "synchronous_bursting") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 120, input_current: 1.4, num_neurons: 15,
            current_start: 0, current_duration: 120, noise: true, noise_intensity: 0.1,
            noise_method: "additive", synapse: true, syn_weight: 1.0, syn_prob: 0.8, output_type: "both"
        });
    } else if (preset === "minimal") {
        setFields({
            threshold: 1.0, reset: 0.0, sim_time: 50, input_current: 1.0, num_neurons: 2,
            current_start: 0, current_duration: 50, noise: false, noise_intensity: 0.0,
            noise_method: "additive", synapse: true, syn_weight: 0.05, syn_prob: 1.0, output_type: "both"
        });
    }
    document.getElementById('preset-desc').innerText = presetDescriptions[preset] || presetDescriptions['custom'];
    toggleNoiseOptions();
    toggleSynapseOptions();
}

function setFields(values) {
    document.querySelector('[name="threshold"]').value = values.threshold;
    document.querySelector('[name="reset"]').value = values.reset;
    document.querySelector('[name="sim_time"]').value = values.sim_time;
    document.querySelector('[name="input_current"]').value = values.input_current;
    document.querySelector('[name="num_neurons"]').value = values.num_neurons;
    document.querySelector('[name="current_start"]').value = values.current_start;
    document.querySelector('[name="current_duration"]').value = values.current_duration;
    document.getElementById('noise').checked = values.noise;
    document.getElementById('noise_intensity').value = values.noise_intensity;
    document.getElementById('noise_method').value = values.noise_method;
    document.getElementById('synapse').checked = values.synapse;
    document.getElementById('syn_weight').value = values.syn_weight;
    document.getElementById('syn_prob').value = values.syn_prob;
    document.getElementById('output_type').value = values.output_type;
}

function getFields() {
    return {
        threshold: parseFloat(document.querySelector('[name="threshold"]').value),
        reset: parseFloat(document.querySelector('[name="reset"]').value),
        sim_time: parseInt(document.querySelector('[name="sim_time"]').value),
        input_current: parseFloat(document.querySelector('[name="input_current"]').value),
        num_neurons: parseInt(document.querySelector('[name="num_neurons"]').value),
        current_start: parseInt(document.querySelector('[name="current_start"]').value),
        current_duration: parseInt(document.querySelector('[name="current_duration"]').value),
        noise: document.getElementById('noise').checked,
        noise_intensity: parseFloat(document.getElementById('noise_intensity').value),
        noise_method: document.getElementById('noise_method').value,
        synapse: document.getElementById('synapse').checked,
        syn_weight: parseFloat(document.getElementById('syn_weight').value),
        syn_prob: parseFloat(document.getElementById('syn_prob').value),
        output_type: document.getElementById('output_type').value
    };
}

function resetDefaults() {
    setFields(defaults);
    document.getElementById('preset').value = "custom";
    document.getElementById('preset-desc').innerText = presetDescriptions['custom'];
    toggleNoiseOptions();
    toggleSynapseOptions();
}

function toggleNoiseOptions() {
    const noiseBox = document.getElementById('noise');
    const noiseOptions = document.getElementById('noise-options');
    // 4. Disable hidden fields
    noiseOptions.style.display = noiseBox.checked ? 'block' : 'none';
    Array.from(noiseOptions.querySelectorAll('input,select')).forEach(el => {
        el.disabled = !noiseBox.checked;
    });
}

function toggleSynapseOptions() {
    const synBox = document.getElementById('synapse');
    const synOptions = document.getElementById('synapse-options');
    // 4. Disable hidden fields
    synOptions.style.display = synBox.checked ? 'block' : 'none';
    Array.from(synOptions.querySelectorAll('input,select')).forEach(el => {
        el.disabled = !synBox.checked;
    });
}

function showModelFields(model) {
    // 4. Disable hidden fields for model-specific params
    const izhFields = document.getElementById('izhikevich-fields');
    const adexFields = document.getElementById('adex-fields');
    const customFields = document.getElementById('custom-fields');
    izhFields.style.display = (model === 'izhikevich') ? 'block' : 'none';
    adexFields.style.display = (model === 'adex') ? 'block' : 'none';
    customFields.style.display = (model === 'custom') ? 'block' : 'none';
    Array.from(izhFields.querySelectorAll('input')).forEach(el => { el.disabled = (model !== 'izhikevich'); });
    Array.from(adexFields.querySelectorAll('input')).forEach(el => { el.disabled = (model !== 'adex'); });
    Array.from(customFields.querySelectorAll('input,textarea')).forEach(el => { el.disabled = (model !== 'custom'); });

    const thresholdReset = document.getElementById('threshold-reset-fields');
    const thresholdInput = document.getElementById('threshold');
    const resetInput = document.getElementById('reset');
    const help = document.getElementById('threshold-reset-help');
    if (model === 'lif') {
        thresholdReset.style.display = 'block';
        thresholdInput.disabled = false;
        resetInput.disabled = false;
        help.textContent = "Used for LIF only.";
    } else {
        thresholdReset.style.display = 'block';
        thresholdInput.disabled = true;
        resetInput.disabled = true;
        help.textContent = "Ignored for this model.";
    }

    const inputCurrentHelp = document.getElementById('input-current-help');
    if (model === 'adex') {
        inputCurrentHelp.textContent = "Units: pA (picoamperes) for AdEx.";
    } else {
        inputCurrentHelp.textContent = "Units: Arbitrary for LIF/Izhikevich.";
    }
}

// 7. Simple client-side validation
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('simForm').addEventListener('submit', function(e) {
        let valid = true;
        let msg = [];
        if (parseInt(document.querySelector('[name="num_neurons"]').value) < 1) {
            valid = false;
            msg.push("Number of neurons must be at least 1.");
        }
        if (parseFloat(document.querySelector('[name="sim_time"]').value) <= 0) {
            valid = false;
            msg.push("Simulation time must be positive.");
        }
        if (!valid) {
            e.preventDefault();
            alert(msg.join('\n'));
        }
    });
});

// 11. Keyboard navigation: focus styles for accessibility
document.addEventListener('keydown', function(e) {
    if (e.key === "Tab") {
        document.body.classList.add('user-is-tabbing');
    }
});
</script>
</body>
</html>
